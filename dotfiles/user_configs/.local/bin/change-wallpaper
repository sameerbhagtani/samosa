#!/bin/bash

WALLPAPER_DIR="$HOME/Pictures/wallpapers"
STATE_FILE="$HOME/.cache/hyprpaper_index"

mkdir -p "$(dirname "$STATE_FILE")"

mapfile -t wallpapers < <(find "$WALLPAPER_DIR" -maxdepth 1 -type f \( \
    -iname "*.jpg" -o -iname "*.png" -o -iname "*.jpeg" -o -iname "*.webp" \
\) | sort)

COUNT=${#wallpapers[@]}
[ "$COUNT" -eq 0 ] && exit 1

INDEX=0
[ -f "$STATE_FILE" ] && INDEX=$(cat "$STATE_FILE")
(( INDEX >= COUNT )) && INDEX=0

CURRENT="${wallpapers[$INDEX]}"

echo "ok (index $INDEX -> $CURRENT)"

for monitor in $(hyprctl monitors | grep 'Monitor' | awk '{ print $2 }'); do
    hyprctl hyprpaper wallpaper "$monitor,$CURRENT"
done

NEXT_INDEX=$(( (INDEX + 1) % COUNT ))
echo "$NEXT_INDEX" > "$STATE_FILE"